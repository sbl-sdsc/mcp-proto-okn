{{- if .Values.gateway.enabled -}}
{{/*
  Kubernetes Gateway API â€” HTTPRoute for sub-path routing.

  Requires:
    - gateway.networking.k8s.io CRDs installed
    - An existing Gateway resource (values.gateway.gatewayName)

  Path prefix /mcp/proto-okn is matched and the prefix is stripped before
  forwarding to the backing Service, so the container receives requests at
  its own /mcp path.

  Enable by setting in values.yaml:
    ingress.enabled: false
    gateway.enabled: true
    gateway.gatewayName: <your-gateway>
*/}}
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: {{ include "mcp-proto-okn.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "mcp-proto-okn.labels" . | nindent 4 }}
spec:
  parentRefs:
    - name: {{ .Values.gateway.gatewayName }}
      {{- if .Values.gateway.gatewayNamespace }}
      namespace: {{ .Values.gateway.gatewayNamespace }}
      {{- end }}
  hostnames:
    - {{ .Values.gateway.host | quote }}
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: {{ .Values.basePath }}
      filters:
        - type: URLRewrite
          urlRewrite:
            path:
              type: ReplacePrefixMatch
              # Strip the basePath; the container's MCP endpoint is at /mcp
              replacePrefixMatch: /
      backendRefs:
        - name: {{ include "mcp-proto-okn.fullname" . }}
          port: {{ .Values.service.port }}
{{- end }}
