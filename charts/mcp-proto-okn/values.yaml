# ──────────────────────────────────────────────────────────────────────────────
# mcp-proto-okn — default Helm values
# ──────────────────────────────────────────────────────────────────────────────

# -- Container image configuration
image:
  repository: ghcr.io/frink-okn/mcp-proto-okn
  pullPolicy: IfNotPresent
  # Defaults to the chart appVersion when blank
  tag: ""

imagePullSecrets: []

# -- Deployment replica count
replicaCount: 1

# ── Application ───────────────────────────────────────────────────────────────

# Server mode:
#   "single"  → mcp-proto-okn   (requires sparqlEndpoint below)
#   "unified" → mcp-proto-okn-unified (all 27+ Proto-OKN graphs, no endpoint needed)
serverMode: single

# SPARQL endpoint URL — required when serverMode=single
# Can also be supplied via sparqlEndpointSecret (takes precedence)
sparqlEndpoint: ""

# -- Optional: read the endpoint URL from an existing Secret
# sparqlEndpointSecret:
#   name: my-secret
#   key: endpoint-url

# -- Optional: API key for Bearer-token auth (leave blank to disable)
# Can be supplied here (stored in a generated Secret) or via apiKeySecret
apiKey: ""

# -- Optional: read the API key from an existing Secret
# apiKeySecret:
#   name: my-secret
#   key: api-key

# Transport is always streamable-http inside the container
transport: streamable-http
port: 8000

# -- Extra environment variables injected into the container
extraEnv: []
# - name: MY_VAR
#   value: "my-value"

# -- Extra volumes / mounts (e.g. custom registry.json)
extraVolumes: []
extraVolumeMounts: []

# ── Networking ────────────────────────────────────────────────────────────────

service:
  type: ClusterIP
  port: 80
  # Annotations for cloud LB or Prometheus scraping
  annotations: {}

# -- Sub-path routing under a shared domain
# All ingress rules below are relative to basePath
basePath: /mcp/proto-okn

ingress:
  enabled: true

  # Ingress class — set to your controller:
  #   nginx  → kubernetes.io/ingress.class: nginx  (or ingressClassName: nginx)
  #   traefik → ingressClassName: traefik
  className: nginx

  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /$2
    nginx.ingress.kubernetes.io/use-regex: "true"
    # Strip the basePath prefix before forwarding to the container.
    # The container's MCP endpoint is at /mcp — the rewrite-target above
    # maps  /mcp/proto-okn(/mcp/.*)  →  /mcp/...

  # Shared domain — override per environment
  host: platform.example.com

  # TLS — reference an existing cert-manager certificate or a manually created Secret
  tls:
    enabled: true
    secretName: platform-tls

# ── Gateway API (alternative to Ingress) ─────────────────────────────────────
# Set ingress.enabled=false and gateway.enabled=true to use Kubernetes Gateway API
gateway:
  enabled: false
  # Name of the existing Gateway resource in the same namespace
  gatewayName: shared-gateway
  gatewayNamespace: ""   # leave blank for same namespace
  host: platform.example.com
  tls:
    enabled: true
    secretName: platform-tls

# ── Resource requests / limits ────────────────────────────────────────────────

resources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 500m
    memory: 256Mi

# ── Autoscaling ───────────────────────────────────────────────────────────────

autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 5
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

# ── Pod configuration ─────────────────────────────────────────────────────────

serviceAccount:
  create: true
  annotations: {}
  name: ""

podAnnotations: {}
podLabels: {}

podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000

securityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: true
  capabilities:
    drop:
      - ALL

# ── Probes ────────────────────────────────────────────────────────────────────
# FORWARDED_ALLOW_IPS=* in the image means uvicorn accepts any Host header,
# so standard httpGet probes (which send the pod IP as Host) work fine.

livenessProbe:
  httpGet:
    path: /mcp
    port: http
  initialDelaySeconds: 10
  periodSeconds: 30
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /mcp
    port: http
  initialDelaySeconds: 5
  periodSeconds: 10
  timeoutSeconds: 3
  failureThreshold: 3

# ── Scheduling ────────────────────────────────────────────────────────────────

nodeSelector: {}
tolerations: []
affinity: {}
